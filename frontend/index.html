<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>OSRM POC</title>
    <meta name="description" content="OSRM POC">

    <!-- leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
   integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   crossorigin=""/>
   <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
   integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
   crossorigin=""></script>

   <style type="text/css">
        #mapId { height: 600px; }
   </style>
</head>
<body>
    <div id="mapId"></div>
    <script type="text/javascript">
    // center the map at Namba station, Osaka
    var map = L.map('mapId').setView([34.667330, 135.500235], 13);

    // add tite layer
    var token = 'pk.eyJ1Ijoia2VubmV0aG5naGsiLCJhIjoiY2pucXZsbjRvMDF1NTNwbW5mdXBlcXQwYiJ9.i_mwJiu1BU029CAcVEm7rw';
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token='+token, {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox.streets',
        accessToken: token
    }).addTo(map);

    // add tile layer by openstreetmap (but not stable) 
    // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // add markers
    var locations = [
        {
            name: 'Osaka Castle',
            latLng: [34.687607, 135.525966]
        },
        {
            name: 'Kaiyukan',
            latLng: [34.654739, 135.429018]
        }
    ];

    locations.forEach(function(location){
        L.marker(location.latLng, {title: location.name}).addTo(map);
    });

    function reverseLaglng(latLng) {
        return [latLng[1], latLng[0]];
    }
    function formatLagLng(latLng) {
        // for osrm API, need to reverse the latlng
        return reverseLaglng(latLng).join(',');
    }

    function buildApiUrl(locations) {
        var startLatLng = formatLagLng(locations[0].latLng);
        var endLatLng = formatLagLng(locations[1].latLng);

        return 'http://127.0.0.1:5000/route/v1/driving/'+startLatLng+';'+endLatLng+'?steps=true';
    }
    
    // start plotting the route on map
    var waypoints = [];
    fetch(buildApiUrl(locations))
        .then(function(res) {
            return res.json();
        })
        .then(function(data) {
            if (data.code === 'Ok') {
                var route = data.routes[0];
                route.legs[0].steps.forEach(function(step) {
                    step.intersections.forEach(function(intersection) {
                        waypoints.push(reverseLaglng(intersection.location));
                    })
                })

                waypoints.forEach(function(waypoint) {
                    L.marker(waypoint).addTo(map);
                })

                L.polyline(waypoints, {color: 'red'}).addTo(map);
            }
        });        
    </script>
</body>
</html>